import streamlit as st
import pandas as pd

# ãƒšãƒ¼ã‚¸è¨­å®š
st.set_page_config(page_title="BACK SCANNER", layout="wide")

# ==========================================
# 1. ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆè¨­å®šãƒ»ãƒ—ãƒªã‚»ãƒƒãƒˆï¼‰
# ==========================================
st.sidebar.title("BACK SCANNER ğŸ“Š")
st.sidebar.header("âš™ï¸ Screening Preset")

# 3ã¤ã®ãƒ¢ãƒ¼ãƒ‰é¸æŠãƒœã‚¿ãƒ³
col_side1, col_side2, col_side3 = st.sidebar.columns(3)
if col_side1.button("ğŸš€\né€šå¸¸"):
    st.session_state['mode'] = "NORMAL"
    st.sidebar.success("é€šå¸¸ãƒ¢ãƒ¼ãƒ‰é©ç”¨ä¸­")
if col_side2.button("ğŸ›¡ï¸\nå®ˆã‚Š"):
    st.session_state['mode'] = "DEFENSIVE"
    st.sidebar.warning("ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚·ãƒ–é©ç”¨ä¸­")
if col_side3.button("â¡ï¸\næ¨ªé€™"):
    st.session_state['mode'] = "RANGE"
    st.sidebar.info("æ¨ªã°ã„å¯¾ç­–é©ç”¨ä¸­")

# æ—¢å­˜ã®BACK TESTERã®ã‚µã‚¤ãƒ‰ãƒãƒ¼é …ç›®ï¼ˆã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ç­‰ï¼‰
st.sidebar.divider()
st.sidebar.subheader("Detailed Settings")
ma_span = st.sidebar.slider("ç§»å‹•å¹³å‡æœŸé–“", 5, 200, 25)

# ==========================================
# 2. å…±é€šã‚¨ãƒªã‚¢ï¼ˆéŠ˜æŸ„ã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼‰
# ==========================================
# ã“ã“ã«ç½®ãã“ã¨ã§ã€ã©ã®ã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆã¦ã‚‚å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™
st.subheader("ğŸ¯ Target Tickers")

# ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒ¼ãƒˆã‚’ä½¿ã£ã¦ã€ãƒ¯ãƒ³ã‚¿ãƒƒãƒãƒœã‚¿ãƒ³ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
if 'target_tickers' not in st.session_state:
    st.session_state['target_tickers'] = "7203.T, 9984.T" # åˆæœŸå€¤

# ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢
tickers_input = st.text_area(
    "éŠ˜æŸ„ã‚³ãƒ¼ãƒ‰ (è‡ªå‹•å…¥åŠ›ã¾ãŸã¯æ‰‹å‹•å…¥åŠ›)",
    value=st.session_state['target_tickers'],
    height=68,
    key="input_area" # ã“ã‚Œã§æ›¸ãæ›ãˆåˆ¶å¾¡ãŒå¯èƒ½
)

# ==========================================
# 3. ãƒ¡ã‚¤ãƒ³ã‚¿ãƒ–ã‚¨ãƒªã‚¢
# ==========================================
tab1, tab2, tab3 = st.tabs(["ğŸ  ãƒˆãƒƒãƒ—ç”»é¢ (One-Touch)", "ğŸ” ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°è©³ç´°", "ğŸ“ˆ ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè©³ç´°"])

# ------------------------------------------
# â–  ã‚¿ãƒ–1ï¼šãƒˆãƒƒãƒ—ç”»é¢ï¼ˆãƒ¯ãƒ³ã‚¿ãƒƒãƒåˆ¤å®š & åœ°åˆã„ï¼‰
# ------------------------------------------
with tab1:
    # --- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æƒ…å ± (Expanderã§é–‹é–‰) ---
    with st.expander("ğŸŒ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å¸‚å ´æƒ…å ± (ã‚¿ãƒƒãƒ—ã—ã¦è¡¨ç¤º)", expanded=True):
        # æœ¬æ¥ã¯ã“ã“ã§yfinanceå–å¾—
        # æŒ‡æ¨™ãƒªã‚¹ãƒˆ: æ—¥çµŒå…ˆç‰©, NYãƒ€ã‚¦, ãƒŠã‚¹ãƒ€ãƒƒã‚¯, ãƒ‰ãƒ«å††, åŸæ²¹, Gold, é‡‘åˆ©, VIX
        col1, col2, col3, col4 = st.columns(4)
        col1.metric("æ—¥çµŒå…ˆç‰© (CME)", "39,500", "+1.2%")
        col2.metric("NYãƒ€ã‚¦", "38,800", "+0.5%")
        col3.metric("ãƒ‰ãƒ«/å††", "148.50", "-0.10")
        col4.metric("Gold (COMEX)", "2,050", "+0.8%")
        
        col5, col6, col7, col8 = st.columns(4)
        col5.metric("åŸæ²¹ (WTI)", "75.40", "-1.5%")
        col6.metric("ç±³10å¹´é‡‘åˆ©", "4.12%", "+0.05%")
        col7.metric("VIXæŒ‡æ•°", "13.5", "-5.0%")
        col8.metric("ãƒŠã‚¹ãƒ€ãƒƒã‚¯", "16,200", "+1.1%")
        
        st.info("ğŸ¤– **AIäºˆæ¸¬:** ç±³å›½æ ªé«˜ã¨å††å®‰ã‚’èƒŒæ™¯ã«ã€æ˜æ—¥ã®æ—¥çµŒå¹³å‡ã¯**ã€Œå …èª¿ãªä¸Šæ˜‡ã€**ãŒäºˆæƒ³ã•ã‚Œã¾ã™ã€‚æŠ¼ã—ç›®è²·ã„å„ªå‹¢ã®åœ°åˆã„ã§ã™ã€‚")

    st.divider()

    # --- ãƒ¯ãƒ³ã‚¿ãƒƒãƒãƒœã‚¿ãƒ³ ---
    st.write("### ğŸš€ AI Auto-Analysis")
    st.write("ç¾åœ¨ã®åœ°åˆã„è¨­å®šã«åŸºã¥ãã€ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã‹ã‚‰ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆã¾ã§ä¸€æ‹¬å®Ÿè¡Œã—ã€Top5ã‚’æŠ½å‡ºã—ã¾ã™ã€‚")
    
    if st.button("ãƒ¯ãƒ³ã‚¿ãƒƒãƒåˆ¤å®šã‚’å®Ÿè¡Œ (Start)", type="primary", use_container_width=True):
        with st.spinner("å…¨å¸‚å ´ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­... ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­..."):
            import time
            time.sleep(1) # å‡¦ç†ã—ã¦ã‚‹ãƒ•ãƒª
            
            # --- å‡¦ç†çµæœã®ãƒ€ãƒŸãƒ¼ ---
            # ã“ã“ã§æœ¬æ¥ã¯è¨ˆç®—ã‚’è¡Œã„ã€Top5ã‚’é¸å‡ºã—ã¾ã™
            top5_results = [
                {"Code": "6758.T", "Name": "ã‚½ãƒ‹ãƒ¼G", "PF": 2.5, "WinRate": "68%"},
                {"Code": "8035.T", "Name": "æ±ã‚¨ãƒ¬ã‚¯", "PF": 2.1, "WinRate": "62%"},
                {"Code": "6861.T", "Name": "ã‚­ãƒ¼ã‚¨ãƒ³ã‚¹", "PF": 1.9, "WinRate": "60%"},
                {"Code": "4063.T", "Name": "ä¿¡è¶ŠåŒ–å­¦", "PF": 1.8, "WinRate": "58%"},
                {"Code": "7203.T", "Name": "ãƒˆãƒ¨ã‚¿", "PF": 1.5, "WinRate": "55%"},
            ]
            
            # 1. çµæœã‚µãƒãƒªãƒ¼è¡¨ç¤º
            st.success("åˆ†æå®Œäº†ï¼æœ‰æœ›éŠ˜æŸ„ãƒˆãƒƒãƒ—5ã‚’æŠ½å‡ºã—ã¾ã—ãŸã€‚")
            st.table(pd.DataFrame(top5_results))
            
            # 2. ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›æ ã«è‡ªå‹•è»¢é€
            new_codes = ", ".join([d["Code"] for d in top5_results])
            st.session_state['target_tickers'] = new_codes
            st.experimental_rerun() # ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦å…¥åŠ›æ ã‚’æ›´æ–°

# ------------------------------------------
# â–  ã‚¿ãƒ–2ï¼šã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°è©³ç´°
# ------------------------------------------
with tab2:
    st.header("ğŸ” Custom Screening")
    st.write("ãƒˆãƒƒãƒ—ç”»é¢ã§æŠ½å‡ºã•ã‚ŒãŸéŠ˜æŸ„ã€ã¾ãŸã¯å…¥åŠ›ã•ã‚ŒãŸéŠ˜æŸ„ã®è©³ç´°æ¡ä»¶ã‚’ç¢ºèªã—ã¾ã™ã€‚")
    # ã“ã“ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ç”»é¢ãªã©ãŒå…¥ã‚‹

# ------------------------------------------
# â–  ã‚¿ãƒ–3ï¼šãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆè©³ç´°
# ------------------------------------------
with tab3:
    st.header("ğŸ“ˆ Backtest Detail")
    st.write(f"ç¾åœ¨é¸æŠä¸­ã®éŠ˜æŸ„: **{tickers_input}**")
    st.write("ä¸Šè¨˜ã®éŠ˜æŸ„ã«ã¤ã„ã¦ã€å€‹åˆ¥ã®è©³ç´°ãƒãƒƒã‚¯ãƒ†ã‚¹ãƒˆãƒãƒ£ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ã¾ã™ã€‚")
    # ã“ã“ã«BACK TESTERã®ãƒãƒ£ãƒ¼ãƒˆæç”»æ©Ÿèƒ½ãŒå…¥ã‚‹
